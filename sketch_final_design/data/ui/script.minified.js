function onRequest(e,t){return new Promise((n,a)=>{var o=new XMLHttpRequest;o.addEventListener("load",function(){t.isPlainResponse?n(this.responseText):n(JSON.parse(this.responseText.replace(/[\r\n]/g,"")))}),o.open(t.method,e),t.params&&t.params.forEach(e=>{o.setRequestHeader(e.key,e.value)}),o.send(t.params||null)})}function getMeasurementValues(e){return onRequest(`/api/${e}`,{method:"GET"})}function changeConfig(e,t,n){return onRequest(`/api/${e}/${t}`,{method:"POST",params:n})}function getClock(){return onRequest("/api/clock/get",{method:"GET"})}function setClock(e){return onRequest("/api/clock/set",{method:"POST",params:e})}function getBatteryLevel(){return onRequest("/api/battery",{method:"GET"})}function getPageInit(){return onRequest("/api/init",{method:"GET"})}function getAllFilesFromStorage(){return onRequest("/api/files/all",{method:"GET"})}function getFileFromStorage(e){return onRequest("/api/files/get",{method:"POST",params:[{key:"filename",value:e}],isPlainResponse:!0})}async function deleteFlash(){return onRequest("/api/files/delete",{method:"GET"})}const endpoints={getMeasurementValues:getMeasurementValues,changeConfig:changeConfig,getClock:getClock,setClock:setClock,getBatteryLevel:getBatteryLevel,getPageInit:getPageInit,getAllFilesFromStorage:getAllFilesFromStorage,getFileFromStorage:getFileFromStorage,deleteFlash:deleteFlash};function renderLoader(e,t){const n=document.createElement("div");return n.classList.add("loader"),n.classList.add(`loader-${e}`),n.classList.add(`loader_${t}`),n}let intervalRates={temp:void 0,humi:void 0},poolingIntervalIDs={temp:void 0,humi:void 0},isFirstCall={temp:!0,humi:!0},isAJAXCallInProgress={temp:!1,humi:!1};async function renderMeasurementValues(e){if(!isAJAXCallInProgress[e]){let t;isAJAXCallInProgress[e]=!0,isFirstCall[e]?(t=document.querySelector(`.content--loading#content_${e}`)).appendChild(renderLoader("large",e)):(t=document.getElementsByClassName(`loader_current_${e}`)[0])&&t.appendChild(renderLoader("small",e));const n=await endpoints.getMeasurementValues(e);if(isFirstCall[e]){t.classList.remove("content--loading");const n=t.getElementsByClassName(`loader loader_${e}`)[0];n&&n.remove(),isFirstCall[e]=!1}else t.innerHTML="";isAJAXCallInProgress[e]=!1,renderTabMeasurements(n,e),intervalRates[e]!==n.config.rate&&onSetCurrentInterval(e,n.config.rate)}}function renderTabMeasurements(e,t){if(document.getElementById(`measure_${t}_current`).innerHTML="temp"===t?onConvertTemperature(e.current.value):e.current.value,document.getElementById(`measure_${t}_current_timestamp`).innerHTML=e.current.timestamp,e.means&&e.means.forEach((e,n)=>{const a=document.getElementById(`measure_${t}_mean${n}`);if(e.value){document.getElementById(`measure_${t}_mean${n}_value`).innerHTML="temp"===t?onConvertTemperature(e.value):e.value,a.style.display="list-item"}else a.style.display="none"}),e.recordMax){document.getElementById(`measure_${t}_max`).innerHTML="temp"===t?onConvertTemperature(e.recordMax.value):e.recordMax.value,document.getElementById(`measure_${t}_max_timestamp`).innerHTML=e.recordMax.timestamp}if(e.recordMin){document.getElementById(`measure_${t}_min`).innerHTML="temp"===t?onConvertTemperature(e.recordMin.value):e.recordMin.value,document.getElementById(`measure_${t}_min_timestamp`).innerHTML=e.recordMin.timestamp}const n=document.getElementById(`alarm_led_${t}`);e.alarm?n.classList.add("alarm-on"):n.classList.remove("alarm-on")}function onSetCurrentInterval(e,t){intervalRates[e]=t,poolingIntervalIDs[e]=setInterval(()=>renderMeasurementValues(e),1e3*intervalRates[e])}function onUpdateCurrentInterval(e,t){intervalRates[e]=t,clearInterval(poolingIntervalIDs[e]),poolingIntervalIDs[e]=setInterval(()=>renderMeasurementValues(e),1e3*intervalRates[e])}async function onSubmitConfig(e,t){const n=document.getElementById(`config_${e}_${t}`);let a=Number(n.value);if("thres"===t&&(!(a="temp"===e&&"thres"===t?onDeconvertTemperature(a,currentTempUnits):a)||a<0||a>100))return void alert("Value must be between 0 and 100 ºC (32 and 212 in ºF -- 273.2 and 373.2 in K)");const o=[{key:"value",value:a}],r=await endpoints.changeConfig(e,t,o);if(r.success){"rate"==t&&onUpdateCurrentInterval(e,r.value);const n=document.getElementById(`config_${e}_${t}_value`);if(n){const a="temp"===e&&"thres"===t?onConvertTemperature(r.value):r.value;n.innerHTML=a}}}renderMeasurementValues("temp"),renderMeasurementValues("humi");const tempRateSubmitBtn=document.getElementById("config_temp_rate_submit"),humiRateSubmitBtn=document.getElementById("config_humi_rate_submit");tempRateSubmitBtn.addEventListener("click",()=>onSubmitConfig("temp","rate")),humiRateSubmitBtn.addEventListener("click",()=>onSubmitConfig("humi","rate"));const tempThresSubmitBtn=document.getElementById("config_temp_thres_submit"),humiThresSubmitBtn=document.getElementById("config_humi_thres_submit");tempThresSubmitBtn.addEventListener("click",()=>onSubmitConfig("temp","thres")),humiThresSubmitBtn.addEventListener("click",()=>onSubmitConfig("humi","thres"));const clockValueEl=document.getElementById("clock_value"),clockHourInput=document.getElementById("clock_set_hour"),clockMinuteInput=document.getElementById("clock_set_min");async function onGetClock(){const e=await endpoints.getClock();clockValueEl.innerHTML=`${e.hour}:${e.minute}`}async function onSubmitClock(){const e=[{key:"hour",value:clockHourInput.value},{key:"minute",value:clockMinuteInput.value}],{value:t}=await endpoints.setClock(e);clockValueEl.innerHTML=`${t.hour}:${t.minute}`,clockHourInput.value=`${t.hour}`,clockMinuteInput.value=`${t.minute}`}onGetClock(),setInterval(onGetClock,3e4);const clockSubmitEl=document.getElementById("clock_submit");clockSubmitEl.addEventListener("click",onSubmitClock);let currentTempUnits="c";function onChangeTemperatureUnits(e){const t=currentTempUnits;let n="";switch(currentTempUnits=e.target.value){case"c":n="ºC";break;case"f":n="ºF";break;case"k":n="K"}const a=document.getElementById("content_temp").querySelectorAll(".measure_value_units");for(let e=0;e<a.length;e++){a[e].innerHTML=n;const o=a[e].previousElementSibling,r=o.innerHTML,s=Number(r);if(r&&!isNaN(s)){const e=onDeconvertTemperature(s,t);o.innerHTML=onConvertTemperature(e)}}}function onConvertTemperature(e){if(null===e)return null;let t="";switch(currentTempUnits){case"c":t=Number(e);break;case"f":t=1.8*e+32;break;case"k":t=e+273.2}return t.toFixed(1)}function onDeconvertTemperature(e,t){let n=null;switch(t){case"c":n=Number(e);break;case"f":n=(e-32)/1.8;break;case"k":n=e-273.2}return n}const tempUnitsSelect=document.getElementById("config_temp_units");tempUnitsSelect.addEventListener("change",onChangeTemperatureUnits);const batteryValueEl=document.getElementById("battery_value");async function onGetBatteryLevel(){const{value:e}=await endpoints.getBatteryLevel();batteryValueEl.innerHTML=e}async function onGetPageInit(){await endpoints.getPageInit()}onGetBatteryLevel(),setInterval(onGetBatteryLevel,2e4),onGetPageInit();const fileIcon='\n    <svg height="18px" viewBox="0 0 24 24" width="18px" fill="#004">\n        <path d="M0 0h24v24H0V0z" fill="none"/>\n        <path d="M8 16h8v2H8zm0-4h8v2H8zm6-10H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>\n    </svg>\n';function onRenderStorageFiles(e,t){t.innerHTML="",e.forEach(e=>{const n=document.createElement("li");n.classList.add("storage_nav_list_el"),n.setAttribute("name",e),n.innerHTML=fileIcon+e,n.addEventListener("click",onFetchFileContent),t.appendChild(n)})}async function onFetchStorageFiles(){const e=document.getElementById("storage_nav_list");e.appendChild(renderLoader("medium")),onRenderStorageFiles(await endpoints.getAllFilesFromStorage(),e)}async function onFetchFileContent(e){const t=e.currentTarget;if(!t.classList.contains("storage_nav_list_el--selected")){const e=document.getElementById("storage_nav_list");for(let t=0;t<e.children.length;t++)e.children[t].classList.remove("storage_nav_list_el--selected");t.classList.add("storage_nav_list_el--selected");const n=document.getElementById("storage_display");n.innerHTML="",n.appendChild(renderLoader("medium")),n.classList.add("storage_display--no-file");const a=t.getAttribute("name");let o=await endpoints.getFileFromStorage(a);o=(o=(o=o.replaceAll("���","\n")).replaceAll("��","\n")).replaceAll("\n\r\n","\n"),n.innerHTML="",n.classList.remove("storage_display--no-file"),n.innerHTML=o}}function onMountStorage(){const e=document.getElementById("storage_display");e.innerHTML="Select a file to view its contents",e.classList.add("storage_display--no-file"),document.getElementById("storage_nav_list").innerHTML="",onFetchStorageFiles()}async function onStorageDelete(){if(confirm("Are you sure you want to delete the entire flash?")){const e=document.getElementById("storage_nav_list");e.appendChild(renderLoader("medium"));const t=document.getElementById("storage_display");t.innerHTML="Select a file to view its contents",t.classList.add("storage_display--no-file"),onRenderStorageFiles(await endpoints.deleteFlash(),e)}}const storageDeleteEl=document.getElementById("storage_delete");storageDeleteEl.addEventListener("click",onStorageDelete);const localStorage=window.localStorage,LOCAL_STORAGE_KEY_TAB="WEATHER_STATION_TAB",tabButtons={temp:document.querySelector("[data-tab-id=temp]"),humi:document.querySelector("[data-tab-id=humi]"),storage:document.querySelector("[data-tab-id=storage]")},tabContents={temp:document.querySelector("#content_temp"),humi:document.querySelector("#content_humi"),storage:document.querySelector("#content_storage")};function onMountTab(e){switch(e){case"storage":onMountStorage()}}function setTab(e){Object.keys(tabContents).forEach(t=>{t===e?(tabContents[t].classList.remove("content--hidden"),tabButtons[t].classList.add("container_tabs_el--selected")):(tabContents[t].classList.add("content--hidden"),tabButtons[t].classList.remove("container_tabs_el--selected"))}),localStorage.setItem(LOCAL_STORAGE_KEY_TAB,e),onMountTab(e)}function onInit(){let e=localStorage.getItem(LOCAL_STORAGE_KEY_TAB);null===e&&(e="temp"),setTab(e)}tabButtons.temp.onclick=function(){setTab("temp")},tabButtons.humi.onclick=function(){setTab("humi")},tabButtons.storage.onclick=function(){setTab("storage")},onInit();